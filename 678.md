Clever Silver Aphid

Medium

# Users can avoid paying fees by setting feeBips parameter of createOrder function to 0

### Summary

The missing `feeBips > 0` check in `Bracket::createOrder()` and `OracleLess::createOrder()`  can be used to perform trades without paying any fee by users.

### Root Cause

In ``Bracket::_createOrder()` function contract checks if `feeBips <= 10000` which is totaly required however it does not check if  `feeBips > 10000`. However in both `Bracket` and `OracleLess` contracts fees are calculated by the following function:
```solidity
    ///@notice apply the protocol fee to @param amount
    ///@notice fee is in the form of tokenOut after a successful performUpkeep
    function applyFee(
        uint256 amount,
        uint16 feeBips
    ) internal pure returns (uint256 feeAmount, uint256 adjustedAmount) {
        if (feeBips != 0) {
            //determine adjusted amount and fee amount
            adjustedAmount = (amount * (10000 - feeBips)) / 10000;
            feeAmount = amount - adjustedAmount;
        } else {
            return (0, amount);
        }
    }



```
Since feeAmount is calculated by `amount - adjustedAmount`. If  `amount==adjustedAmount` is true, user doesn't pay any fee and if we assume that feeBips is 0 from the following formula : ` (amount * (10000 - 0)) / 10000 = amount * 10000 / 10000` adjusted amount equals amount which means feeAmount becomes 0. Since users are able to createOrder by setting feeBips to 0.  They can always avoid paying fees when they created an order by simply setting feeBips to 0.

### Internal pre-conditions

 User should create an order by using either `OracleLess` or `Bracket` contracts as setting feeBips to 0.

### External pre-conditions

 The order should be fulfilled.

### Attack Path

1. User ensures that he has enough funds to create an order 
2. User creates order as setting feeBips parameter of `CreateOrder()` function to 0.

### Impact

The protocol looses all the fees while it's users incrementing their profits in case their trade is succesful in terms of profit and loss. 


### PoC

The issue can be regenerated by applying following steps : 
1. In [happyPath](https://github.com/sherlock-audit/2024-11-oku/blob/main/oku-custom-order-types/test/triggerV2/happyPath.ts) change [#L942-L951](https://github.com/sherlock-audit/2024-11-oku/blob/main/oku-custom-order-types/test/triggerV2/happyPath.ts#L942-L951) as following :
```solidity
    it("Verify fee", async () => {
        const usdcBalance = await s.USDC.balanceOf(await s.Master.getAddress())
        expect(usdcBalance).to.be.gt(0, "USDC fees accumulated")

        await s.Master.connect(s.Frank).sweep(await s.USDC.getAddress())

        expect(await s.USDC.balanceOf(s.Frank)).to.eq(usdcBalance, "Frank received fees")
        console.log(`USDC Balance of Bob ${ethers.formatUnits(await s.USDC.balanceOf(await s.Bob.getAddress()),6)}`)
    })
```
2. Submit `npm run test` on console. Here is the result of first test : 
![1](https://github.com/user-attachments/assets/7cc3cf10-119c-4f10-9365-a587173d4a3c)

3. Change [this line](https://github.com/sherlock-audit/2024-11-oku/blob/main/oku-custom-order-types/test/triggerV2/happyPath.ts#L521) as following `0,`

4. Submit `npm run test` on console and the latest result:
![2](https://github.com/user-attachments/assets/e394d7bb-39e5-4380-9f3e-4990d3ce994d)
5.Since initial fee was 5 feeBips user makes only 2 usd profit by avoiding paying fee however if feeBips was 10000 result would become following image which means a huge lose for user : 
![3](https://github.com/user-attachments/assets/3845cc51-dc83-491d-b700-58c11de21604)
As the result since the most beneficial way is setting feeBips to 0 and this permits users to avoid paying fees. Each time one or multiple users can use this chance and protocol can affect negatively by tax evasions in long run.



### Mitigation

This issue can be fixed by adding following check inside the `createOrder()` function `require(feeBips > 0, "Fee cannot be 0")`.